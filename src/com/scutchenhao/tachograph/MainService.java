package com.scutchenhao.tachograph;

import java.io.BufferedReader;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.FileReader;
import java.io.IOException;
import java.io.InputStream;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.text.DateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.Iterator;
import java.util.List;

import android.app.Service;
import android.bluetooth.BluetoothAdapter;
import android.bluetooth.BluetoothDevice;
import android.bluetooth.BluetoothSocket;
import android.content.Context;
import android.content.Intent;
import android.location.GpsSatellite;
import android.location.GpsStatus;
import android.location.Location;
import android.location.LocationListener;
import android.location.LocationManager;
import android.net.ConnectivityManager;
import android.net.NetworkInfo;
import android.os.Binder;
import android.os.Bundle;
import android.os.Environment;
import android.os.IBinder;
import android.widget.Toast;

public class MainService extends Service {
	public static final String ID = "3";
	public static final String FILEDIR = Environment.getExternalStorageDirectory().getPath() + "/SerialPortData/";
	private FileOutputStream dataFile;
    private BluetoothAdapter mBluetoothAdapter = null;
    public boolean sendFlag = true;
    public boolean receiveFlag = true;
    public boolean networkAvailableFlag = false;
    private BluetoothSocket btSocket = null;
    private boolean gpsFlag = false;
    private double latitude = 0;
    private double longitude = 0;
    private double altitude = 0;
    private int firstLocated = 0;
    private long firstLocatedTime = 0;
    private int fire = 0;
    private List<BluetoothDevice> deviceList = new ArrayList<BluetoothDevice>();
    private String log = "";
    private List<MyGpsLocation> locationList = new ArrayList<MyGpsLocation>();
    private final IBinder mBinder = new LocalBinder();  
    
    public class LocalBinder extends Binder {  
        MainService getService() {  
            // 返回Activity所关联的Service对象，这样在Activity里，就可调用Service里的一些公用方法和公用属性  
            return MainService.this;  
        }
    }
    
    @Override
    public IBinder onBind(Intent intent) {
    	return mBinder;  
    }

	@Override
	public void onCreate() {
		super.onCreate();
    	sendLog("程序已启动");
    	
        initSdcard();  
        	
        
        initNetwork();

        initLocation(); 
   
		//远程接收数据
        new ReceiveThread().start();
	}
    
	@Override
	public void onDestroy() {
		super.onDestroy();
		sendFlag = false;
		try {
			if (dataFile != null) {
				sendLog("关闭文件");
				dataFile.close();
			} else {
				sendLog("无数据文件");
			}
		} catch (IOException e) {
			sendLog("文件关闭失败");
		}
		sendLog("程序退出，关闭蓝牙");
    	if (mBluetoothAdapter != null) {
    		while(mBluetoothAdapter.getState() == BluetoothAdapter.STATE_TURNING_ON);
    		mBluetoothAdapter.disable();
    	}
    	gpsFlag = false;
    	locationManager.removeGpsStatusListener(gpsStatusListener);
    	locationManager.removeUpdates(gpsListener);
    	locationManager.removeUpdates(gprsListener);
    	
	}
	
    private void sendLog(String msg){  
    	log = log.concat(msg + '\n');
    	Intent mIntent = new Intent(UpdateReceiver.MSG);
    	mIntent.putExtra(UpdateReceiver.DATA_TYPE, UpdateReceiver.LOG_DATA);
    	mIntent.putExtra(UpdateReceiver.DATA, msg);
        this.sendBroadcast(mIntent);
    }
    
    private void sendGPS(Location location){  
    	Intent mIntent = new Intent(UpdateReceiver.MSG);
    	mIntent.putExtra(UpdateReceiver.DATA_TYPE, UpdateReceiver.GPS_DATA);
    	mIntent.putExtra(UpdateReceiver.DATA, location);
        this.sendBroadcast(mIntent);  
    }

    /**
     * SD card
     */
    private void initSdcard() {
        //创建数据文件
        if (!hasSdcard()) {
        	sendLog("未找到sd卡，放弃储存数据");
		} else {
			File dir = new File(FILEDIR);
				if (!dir.exists()) {
					if (dir.mkdir())
						sendLog("创建目录" + FILEDIR);
				}
	        Calendar c = Calendar.getInstance();
	        int year = c.get(Calendar.YEAR); 
	        int month = c.get(Calendar.MONTH) + 1; 
	        int date = c.get(Calendar.DATE); 
	        int hour = c.get(Calendar.HOUR_OF_DAY); 
	        int minute = c.get(Calendar.MINUTE); 
	        int second = c.get(Calendar.SECOND);  
	        try {
	        	File file = new File(FILEDIR + year + "-" + month + "-" + date + " " +hour + "-" +minute + "-" + second + ".txt");
	        	if (!file.exists()){    
	                 try {
						file.createNewFile();
						sendLog("创建记录文件" + file.toString());
					} catch (IOException e) {
						sendLog("创建文件失败");
						return;
					}    
	            }    
	        	dataFile = new FileOutputStream(file);
			} catch (FileNotFoundException e) {
				sendLog("创建文件失败");
			}

        }

    }
    
    public static boolean hasSdcard() {
        String status = Environment.getExternalStorageState();
        if (status.equals(Environment.MEDIA_MOUNTED)) {
            return true;
        } else {
            return false;
        }
    }
    
    public class RecordThread extends Thread {
	    @Override
	    public void run() {
	    	long deltaTime = System.currentTimeMillis();
	        while(sendFlag){
				if (System.currentTimeMillis() - deltaTime >= 500) {
					deltaTime = System.currentTimeMillis();
					new SendThread(":" + latitude + ":" + longitude).start();
				}
	        }
	    }
    }

    /**
     * Network
     */
    private void initNetwork() {
    	if (isConnect(this)) {
    		networkAvailableFlag = true;
    		sendLog("网络正常");
    	} else {
    		networkAvailableFlag = false;
    		sendLog("网络未连接，无法发送接收数据");
    	}
    }
    
    public class ReceiveThread extends Thread {
    	private long time = 0;
	    @Override
	    public void run() {
	    	while(receiveFlag && networkAvailableFlag) {
	    		long newTime = System.currentTimeMillis();
	    		if (newTime - time < 300)
	    			continue;
	    		time = newTime;
	    		
	    		String data = getData();

	    		if (data.contains("n"))
	    			return;
	    		
	    		int i = data.indexOf(':');
	    		int j = data.indexOf(':', data.indexOf(':') + 1);
	    		latitude = Double.parseDouble(data.substring(i + 1, j - 1));
	    		longitude = Double.parseDouble(data.substring(j + 1));
	    		Location location = new Location(LocationManager.GPS_PROVIDER);
	    		location.setLatitude(latitude);
	    		location.setLongitude(longitude);
	    		sendGPS(location);
	    	}
	    }
    }

    public class SendThread extends Thread {
    	String data;
    	public SendThread(String data) {
    		this.data = data;
    	}
    	
	    @Override
	    public void run() {
	    	if (networkAvailableFlag) {
	    		String result = sendData(data);
	    		
	    		if (!result.equals("ok"))
	    			sendLog("数据发送失败：" + result);
	    	}
	    }
    }
    
    private boolean isConnect(Context context) { 
        // 获取手机所有连接管理对象（包括对wi-fi,net等连接的管理） 
	    try { 
	        ConnectivityManager connectivity = (ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE); 
	        if (connectivity != null) { 
	            // 获取网络连接管理的对象 
	            NetworkInfo info = connectivity.getActiveNetworkInfo(); 
	            if (info != null&& info.isConnected()) { 
	                // 判断当前网络是否已经连接 
	                if (info.getState() == NetworkInfo.State.CONNECTED) { 
	                    return true; 
	                } 
	            } 
	        } 
	    } catch (Exception e) { 
	    	sendLog("获取网络状态出错");
	    } 
        return false; 
    } 
    
    /**
     * GPS
     */
    private boolean recordFlag = false;
    private LocationManager locationManager;
    private LocationListener gpsListener = new LocationListener() {
		@Override
		public void onLocationChanged(Location location) {
	        updateToNewLocation(location);
		}

		@Override
		public void onProviderDisabled(String provider) {
			if (firstLocated != 0)
				sendLog("GPS关闭");
		}

		@Override
		public void onProviderEnabled(String provider) {
			sendLog("GPS打开");
		}

		@Override
		public void onStatusChanged(String provider, int status,
				Bundle extras) {
		}
    	
    };
    private LocationListener gprsListener = new LocationListener() {
		@Override
		public void onLocationChanged(Location location) {
	        updateToNewLocation(location);
		}

		@Override
		public void onProviderDisabled(String provider) {
			if (firstLocated != 0)
				sendLog("GPS关闭");
		}

		@Override
		public void onProviderEnabled(String provider) {
			sendLog("GPS打开");
		}

		@Override
		public void onStatusChanged(String provider, int status,
				Bundle extras) {
		}
    	
    };    
    
    private GpsStatus.Listener gpsStatusListener = new GpsStatus.Listener() {
    	private int count = -1;
		@Override
		public void onGpsStatusChanged(int event) {
            switch (event) {
            //第一次定位
            case GpsStatus.GPS_EVENT_FIRST_FIX:
            	sendLog("第一次定位");
                break;
            //卫星状态改变
            case GpsStatus.GPS_EVENT_SATELLITE_STATUS:
//                sendLog("卫星状态改变");
                //获取当前状态
                GpsStatus gpsStatus=locationManager.getGpsStatus(null);
                //获取卫星颗数的默认最大值
                int maxSatellites = gpsStatus.getMaxSatellites();
                //创建一个迭代器保存所有卫星 
                Iterator<GpsSatellite> iters = gpsStatus.getSatellites().iterator();
                int newCount = 0;     
                while (iters.hasNext() && newCount <= maxSatellites) {     
                	newCount++;     
                }   
                if (count != newCount) {
                	sendLog("搜索到：" + newCount + "颗卫星");
                	count = newCount;
                }
                
                break;
            //定位启动
            case GpsStatus.GPS_EVENT_STARTED:
            	sendLog("定位启动");
                //得到最近的Location
                Location location = locationManager.getLastKnownLocation(LocationManager.GPS_PROVIDER);
                if (location == null)
                    location = locationManager.getLastKnownLocation(LocationManager.NETWORK_PROVIDER);
                if (location == null)
                	break;
                latitude = location.getLatitude();
                longitude = location.getLongitude();
                altitude = location.getAltitude();
                break;
            //定位结束
            case GpsStatus.GPS_EVENT_STOPPED:
            	sendLog("定位结束");
                break;
            }
		}
    };
    
    private void initLocation() {
    	gpsFlag = true;
	    locationManager = (LocationManager) this.getSystemService(Context.LOCATION_SERVICE);
	    if (locationManager.isProviderEnabled(android.location.LocationManager.GPS_PROVIDER)) {
            sendLog("GPS模块正常");
        } else {
        	sendLog("GPS模块关闭，请手动打开");
        }
        
        // 设置监听器，自动更新的最小时间为间隔N秒(1秒为1*1000，这样写主要为了方便)或最小位移变化超过N米
        locationManager.addGpsStatusListener(gpsStatusListener);
        List<String> list = locationManager.getAllProviders();
        
		//gprs定位
        if (list.contains(LocationManager.NETWORK_PROVIDER))
        	locationManager.requestLocationUpdates(LocationManager.NETWORK_PROVIDER, 500, 0, gprsListener);
		//GPS 定位
        if (list.contains(LocationManager.GPS_PROVIDER))
        	locationManager.requestLocationUpdates(LocationManager.GPS_PROVIDER, 500, 0, gpsListener);

        
        Thread gpsThread = new Thread() {
			@Override
			public void run() {
				while(gpsFlag) {
					try {
						sleep(500);
					} catch (InterruptedException e1) {
						sendLog("GPS写线程出错");
					}
					if (recordFlag) {
						Date now = new Date();
			            String time = DateFormat.getDateTimeInstance().format(now);
			            String gpsData = "GPS: " + latitude + "," + longitude + "," + altitude + "\r\n";
			        	try {
			        		if (dataFile != null)
			        			dataFile.write((time + '\t' + gpsData).getBytes());
						} catch (IOException e) {
							sendLog("写入GPS数据失败");
						}
		        	}
				}
			}
        };
        gpsThread.start();
    }
	
    private void updateToNewLocation(Location location) {
        if (location != null) {
        	latitude = location.getLatitude();
            longitude = location.getLongitude();
            altitude = location.getAltitude();
            if (firstLocated == 1) {
                firstLocatedTime = System.currentTimeMillis();
            	sendLog("首次定位成功，维度：" +  latitude + "，经度：" + longitude + "，海拔：" + altitude);
        		Toast.makeText(MainService.this, "首次定位成功，维度：" +  latitude + "，经度：" + longitude + "，海拔：" + altitude, Toast.LENGTH_SHORT).show();
            	locationManager.removeUpdates(gprsListener);
        		locationList.clear();
            	firstLocated++;
            } else {
            	firstLocated++;
            }
            sendGPS(location);
            
            if (firstLocated > 1) {
            	if(altitude == 0)		//gprs定位数据，不够准确，忽略掉
            		return;
            		
            	long time = System.currentTimeMillis() - firstLocatedTime;
	            locationList.add(new MyGpsLocation(latitude, longitude, time, fire));
	            
	        /*
	            MyGpsLocation firstLoction = locationList.get(0);
	            double distance = Math.abs(latitude - firstLoction.latitude) + Math.abs(longitude - firstLoction.longitude);
	            if (locationList.size() >= 100 && distance <= 0.001) {		//0.00027 ≈ 30m
	            	Toast.makeText(this, "完成一圈", Toast.LENGTH_SHORT).show();
	            	aRound = true;
	            }
	            if (aRound && distance >= 0.001) {
	            	Toast.makeText(this, "重新开始记录", Toast.LENGTH_SHORT).show();
	            	locationList.clear();
	            	aRound = false;
	            }
	        */
            }
            
        } else {
        	sendLog("无法获取GPS信息");
        }
    }
    
    /**
     * Internet
     */
	protected String getData() {
		try {
			HttpURLConnection connection;
			URL server;
			server = new URL("http://datatransfer.duapp.com/hello?id=" + ID);
			connection = (HttpURLConnection)server.openConnection();
			connection.setReadTimeout(10 * 1000);
			connection.setRequestMethod("GET");
			InputStream inStream = connection.getInputStream();
			ByteArrayOutputStream data = new ByteArrayOutputStream();		//新建一字节数组输出流
			byte[] buffer = new byte[1024];		//在内存中开辟一段缓冲区，接受网络输入流
			int len=0;
			while((len = inStream.read(buffer)) != -1) {
				data.write(buffer, 0, len);		//缓冲区满了之后将缓冲区的内容写到输出流
			}
			inStream.close();
			return new String(data.toByteArray(),"utf-8");		//最后可以将得到的输出流转成utf-8编码的字符串，便可进一步处理
		} catch (MalformedURLException e) {
			sendLog("URL出错");
			return "null";
		} catch (IOException e) {
			sendLog("远程数据获取失败");
			return "null";
		}
	}

	protected String sendData(String content) {
		try {
			HttpURLConnection connection;
			URL server;
			server = new URL("http://datatransfer.duapp.com/hello?id=" + ID + "&data=" + content);
			connection = (HttpURLConnection)server.openConnection();
			connection.setReadTimeout(10 * 1000);
			connection.setRequestMethod("GET");
			InputStream inStream = connection.getInputStream();
			ByteArrayOutputStream data = new ByteArrayOutputStream();//新建一字节数组输出流
			byte[] buffer = new byte[1024];//在内存中开辟一段缓冲区，接受网络输入流
			int len=0;
			while((len=inStream.read(buffer))!=-1){
				data.write(buffer, 0, len);//缓冲区满了之后将缓冲区的内容写到输出流
			}
			inStream.close();
			return new String(data.toByteArray(),"utf-8");//最后可以将得到的输出流转成utf-8编码的字符串，便可进一步处理
		} catch (MalformedURLException e) {
			sendLog("URL出错");
			return "";
		} catch (IOException e) {
			sendLog("远程数据获取失败");
			return "";
		}
	}

    /**
     * Draw Location 
     */
	public class MyGpsLocation {
		public double latitude;
    	public double longitude;
    	public long time;
    	public int fire;
    	
    	MyGpsLocation(double latitude, double longitude, long time, int fire) {
    		this.latitude = latitude;
    		this.longitude = longitude;
    		this.time = time;
    		this.fire = fire;
    	}   	
    }
	
	public void saveLocation() {
		if(!hasSdcard()) {
			Toast.makeText(this, "未找到sdcard，储存失败", Toast.LENGTH_SHORT).show();
			return;
		}
        
		try {
        	File file = new File(FILEDIR + "location_list.txt");
        	if (!file.exists()){    
                 try {
					file.createNewFile();
					sendLog("创建GPS文件" + file.toString());
				} catch (IOException e) {
					sendLog("创建文件失败");
					return;
				}    
            } else {
            	if(!file.delete()) {
					sendLog("删除原有文件失败");
					return;
            	} else {
            		try {
						file.createNewFile();
						sendLog("创建GPS文件" + file.toString());
						
					} catch (IOException e) {
						sendLog("创建文件失败");
						return;
					}
            	}
            }
        	FileOutputStream locationData = new FileOutputStream(file);
    		try {
    			for(MyGpsLocation i: locationList) {
					locationData.write((i.time + "," + i.latitude + "," + i.longitude + "," + i.fire + "\n").getBytes());

				}
    			locationData.close();
        	} catch (IOException e) {
				sendLog("写入位置数据失败");
				return;
        	}
        	
		} catch (FileNotFoundException e) {
			sendLog("创建文件失败");
			return;
		}
		
		Toast.makeText(this, "储存成功，共储存" + locationList.size() + "个GPS信息", Toast.LENGTH_SHORT).show();
	}
	
	public List<MyGpsLocation> loadLocation() {
        try {
        	File file = new File(FILEDIR + "location_list.txt");
        	List<MyGpsLocation> drawList = new ArrayList<MyGpsLocation>();
        	if (!file.exists()){    
				sendLog("无位置数据文件");   
            } else {
            	 BufferedReader locationData = new BufferedReader(new FileReader(file));
            	 try {
            		while (true) {
            			String str = locationData.readLine();
            			if (str == null)
            				break;
            			
            			 int i = str.indexOf(',');
            			 int j = str.indexOf(',', i + 1);
            			 int k = str.indexOf(',', j + 1);
            			 long time = Long.parseLong(str.substring(0, i));
            			 double latitude = Double.parseDouble(str.substring(i + 1, j));
            			 double longitude = Double.parseDouble(str.substring(j + 1, k));
            			 int fire = Integer.parseInt(str.substring(k + 1));
            			 drawList.add(new MyGpsLocation(latitude, longitude, time, fire));
            		}
            		locationData.close();
				} catch (IOException e) {
					sendLog("位置数据格式错误");
					return null;
				}
            }
            return drawList;
        } catch (FileNotFoundException e) {
			sendLog("创建文件失败");
			return null;
		}
        
	}
	
    /**
     * Activity调用
     */
	protected double getAltitude() {
		return altitude;
	}

	protected double getLatitude() {
		return latitude;
	}
	
	protected double getLongitude() {
		return longitude;
	}
	
    protected List<MyGpsLocation> getLocationList() {
    	return loadLocation();
    }

    protected void setRecordFlag(boolean valve) {
    	recordFlag = valve;
    }
    
    protected void refresh() {
		deviceList.clear();
        try {
        	if (btSocket != null) {
            	sendLog("正在关闭原链接。。");
        		btSocket.close();
        	}
            sendFlag = false;		//关闭蓝牙读线程
        } catch (IOException e2) {
        	sendLog("套接字关闭失败");
        }
        
    	mBluetoothAdapter.cancelDiscovery();
    	mBluetoothAdapter.startDiscovery();
    	sendLog("刷新设备列表......");
    }
    
    protected String getLog() {
    	return log;
    }    
    
}